<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Administrador Local</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    html, body { margin: 0; padding: 0; }
    #map {
      height: 500px;
      width: 100%;
      margin-top: 10px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

<h2>Panel de Administrador Local</h2>
<p>Bienvenido, {{ request.user.username }}</p>
<p><a href="/">Inicio</a> | <a href="/accounts/logout/">Cerrar sesi√≥n</a></p>

<hr>

<h3>C√°maras de Seguridad Registradas</h3>
<p><a href="/adminlocal/camaras/nueva/">‚ûï Crear nueva c√°mara</a></p>

<ul>
  {% for camara in camaras %}
    <li>
      <strong>{{ camara.ubicacion }}</strong> ‚Äî Estado: {{ camara.estado }}<br>
      Lat: {{ camara.latitud }}, Lon: {{ camara.longitud }}<br>
      IA: {{ camara.modelo_ia }}<br>
      <a href="/adminlocal/camaras/editar/{{ camara.id }}/">‚úè Editar</a> |
      <a href="/adminlocal/camaras/eliminar/{{ camara.id }}/" onclick="return confirm('¬øEst√°s seguro de que deseas eliminar esta c√°mara?');">üóë Eliminar</a>
    </li>
  {% empty %}
    <li>No hay c√°maras registradas.</li>
  {% endfor %}
</ul>

<hr>

<h3>Zonas Cr√≠ticas Registradas</h3>
<p><a href="/adminlocal/zonas/nueva/">‚ûï Crear nueva zona cr√≠tica</a></p>

<ul>
  {% for zona in zonas %}
    <li>
      <strong>{{ zona.nombre_zona }}</strong> ‚Äî {{ zona.tipo_problema }}<br>
      {{ zona.descripcion }}<br>
      Lat: {{ zona.latitud }}, Lon: {{ zona.longitud }}<br>
      <a href="/adminlocal/zonas/editar/{{ zona.id }}/">‚úè Editar</a> |
      <a href="/adminlocal/zonas/eliminar/{{ zona.id }}/" onclick="return confirm('¬øEliminar esta zona cr√≠tica?');">üóë Eliminar</a>
    </li>
  {% empty %}
    <li>No hay zonas cr√≠ticas registradas.</li>
  {% endfor %}
</ul>

<hr>
<h3>Mapa de C√°maras y Zonas Cr√≠ticas</h3>

<div>
  <label for="filtroZona">Filtrar zonas por tipo:</label>
  <select id="filtroZona">
    <option value="">-- Todas --</option>
    <option value="Accidente">Accidente</option>
    <option value="Inundaci√≥n">Inundaci√≥n</option>
    <option value="Congesti√≥n">Congesti√≥n</option>
  </select>

  <button onclick="centrarMapa()">üìç Centrar en Mocoa</button>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const map = L.map('map').setView([1.2136, -77.2811], 13);
    const zonaLayerGroup = L.layerGroup().addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Cargar c√°maras
    fetch('/api/camaras/')
      .then(res => res.json())
      .then(data => {
        data.data.forEach(cam => {
          L.marker([cam.latitud, cam.longitud])
            .addTo(map)
            .bindPopup(<b>C√°mara:</b> ${cam.ubicacion}<br><b>Estado:</b> ${cam.estado}<br><b>IA:</b> ${cam.modelo_ia});
        });
      });

    // Zonas cr√≠ticas
    let zonas = [];

    function renderZonas(tipo = '') {
      zonaLayerGroup.clearLayers();
      zonas.forEach(zona => {
        if (!tipo || zona.tipo_problema === tipo) {
          const marker = L.circleMarker([zona.latitud, zona.longitud], {
            radius: 8,
            color: 'red',
            fillOpacity: 0.6
          }).bindPopup(<b>Zona Cr√≠tica:</b> ${zona.nombre_zona}<br><b>Tipo:</b> ${zona.tipo_problema}<br>${zona.descripcion});
          zonaLayerGroup.addLayer(marker);
        }
      });
    }

    fetch('/api/zonas/')
      .then(res => res.json())
      .then(data => {
        zonas = data.data;
        renderZonas();
      });

    document.getElementById('filtroZona').addEventListener('change', function () {
      renderZonas(this.value);
    });

    window.centrarMapa = function () {
      map.setView([1.2136, -77.2811], 13);
    };
  });
</script>

</body>
</html>